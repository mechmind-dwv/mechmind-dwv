name: "ðŸ“Š MechMind Stats Updater Pro"

on:
  schedule:
    - cron: "0 */6 * * *"  # Cada 6 horas (UTC)
  workflow_dispatch:
    inputs:
      theme:
        description: 'Tema para las tarjetas (radical, dark, etc)'
        required: false
        default: 'radical'
      force_update:
        description: 'Forzar actualizaciÃ³n ignorando cachÃ©'
        required: false
        default: 'false'

jobs:
  update-stats:
    name: "âš¡ Update README Stats"
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Permiso esencial para commits
      pull-requests: write  # Para futuras integraciones

    steps:
      - name: "ðŸ›°ï¸ Checkout Profundo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Historial completo para anÃ¡lisis
          persist-credentials: false  # MÃ¡s seguro

      - name: "ðŸ“Š Generar EstadÃ­sticas Inteligentes"
        uses: anuraghazra/github-readme-stats@v4.2.1
        id: stats
        with:
          username: mechmind-dwv
          theme: ${{ inputs.theme || 'radical' }}
          show_icons: true
          hide_border: true
          include_all_commits: true
          count_private: true
          cache_seconds: ${{ inputs.force_update == 'true' && '0' || '43200' }}  # 12h cache
          exclude_repo: 'deprecated-project,test-sandbox'  # Filtro opcional

      - name: "ðŸ” DetecciÃ³n de Cambios"
        id: changes
        run: |
          git diff --quiet README.md || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: "ðŸ’¾ Commit Seguro"
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "MechMind Bot v2.0"
          git config --global user.email "mechmind-ops@bots.github"
          git add README.md
          git commit -m "ðŸ“ˆ Auto-update stats [skip ci] --theme=${{ inputs.theme }}"
          git push origin HEAD:${{ github.ref }}

      - name: "ðŸ“Œ Notificar sin Cambios"
        if: steps.changes.outputs.has_changes != 'true'
        run: |
          echo "ðŸ”„ No se detectaron cambios en las estadÃ­sticas" >> $GITHUB_STEP_SUMMARY
          echo "Cache vÃ¡lida hasta: $(date -d '+12 hours')" >> $GITHUB_STEP_SUMMARY
